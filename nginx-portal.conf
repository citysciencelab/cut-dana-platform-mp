server {
    listen 80;
    server_name localhost;

    # This location handles the root URL, redirecting to your app's entry point.
    location = / {
        return 301 /portal/stories/;
    }

    # This regex location block is the key to the solution.
    # It matches any request starting with /portal/ and captures the rest of the path
    # into a variable named $request_path.
    # e.g., for a request to /portal/mastercode/foo.css, $request_path becomes "mastercode/foo.css".
    location ~ ^/portal/(?<request_path>.*)$ {
        # The 'alias' directive maps the URL space to the filesystem directory.
        # It tells Nginx that any request matching this location should look for files
        # inside /usr/share/nginx/html/.
        alias /usr/share/nginx/html/;

        # 'try_files' now uses the captured $request_path variable instead of the original $uri.
        # 1. It looks for a file matching the captured path inside the aliased directory.
        #    e.g., it checks for /usr/share/nginx/html/mastercode/foo.css. This will
        #    correctly find and serve all your JS, CSS, and image assets.
        # 2. If it's not a file (e.g., for an SPA route like "stories/page"), it falls back
        #    to serving the main /index.html file from the aliased directory. This allows
        #    your client-side router to take over.
        try_files $request_path $request_path/ /index.html;
    }

    # Your health check endpoint remains unchanged.
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
